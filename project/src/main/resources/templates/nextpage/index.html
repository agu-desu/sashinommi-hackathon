<!DOCTYPE html>
<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:th="http://www.thymeleaf.org"
  lang="ja"
>
  <head>
    <title>サシノミ!!</title>
    <meta charset="utf-8" />
    <style>
      #chat-container {
        width: 300px;
        height: 400px;
        border: 1px solid #ddd;
        overflow-y: auto;
        padding: 10px;
      }
      .chat-message {
        margin: 10px 0;
        padding: 10px;
        border-radius: 5px;
        background-color: #f1f1f1;
      }
      .user-message {
        background-color: #d1f7c4;
        text-align: right;
      }
    </style>
    <script>
      let intervalId;
      document.addEventListener("DOMContentLoaded", function () {
        // 初回データ取得
        fetchChatData();

        intervalId = setInterval(() => {
          fetchChatData().then((data) => displayChatMessages(data));
        }, 10000);

        // チャットデータを取得する関数
        function fetchChatData() {
          return fetch("/api/getChat")
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }
              return response.json();
            })
            .catch(handleFetchError);
        }

        // エラーハンドリングの関数
        function handleFetchError(error) {
          console.error("Error fetching chat data:", error);
        }

        function displayChatMessages(messages) {
          const chatContainer = document.getElementById("chat-container");

          // すでにあるメッセージをクリア
          chatContainer.innerHTML = "";

          messages.reverse();

          // 取得したメッセージを順番に追加
          messages.forEach((message, index) => {
            const messageElement = document.createElement("div");
            messageElement.className = "chat-message";

            // メッセージの内容を設定
            messageElement.textContent = `${message.name}: ${message.message}: ${message.sendTime}`;

            // ユーザーごとにスタイルを変更する場合
            if (index % 2 === 0) {
              // 偶数番目のメッセージ
              messageElement.classList.add("user-message");
            }

            // チャットコンテナにメッセージを追加
            chatContainer.appendChild(messageElement);
          });

          // 最新のメッセージにスクロール
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      });

      // ページが破棄されるときにスケジューリングを解除
      //                        matchingのレコードも削除
      window.addEventListener("beforeunload", function () {
        if (intervalId) {
          clearInterval(intervalId); // タイマーを解除

          let matchingId = /*[[${matchingId}]]*/"lost";
          matchingId = toString(matchingId)
          let url = 'http://localhost:8080/api/deleteMatch?matchingId=';
          url += matchingId;
          fetch(url, {
            method:'GET',
          }).catch(e);
        }
      });
    </script>
  </head>
    <div th:if="${url} != null">
      <p>マッチング完了<br>URL:<span th:text="${url}"></span></p>
    </div>
    <div th:if="${url} == null">
      <p>マッチング中</p>
    </div>    
    <h1>待機時掲示板</h1>
    <div id="messages"></div>
    <div id="chat-container"></div>
  </body>
</html>
